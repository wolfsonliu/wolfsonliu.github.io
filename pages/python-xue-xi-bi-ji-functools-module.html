<!doctype html>
<html lang="zh" itemscope itemtype="http://schema.org/Person">
<head>
  <meta charset="utf-8">
  <!-- Site Meta Data -->
  <title>Python 学习笔记: functools module</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="">
  <meta name="author" content="Wolfson Liu">

  <link rel="shortcut icon" href="https://wolfsonliu.github.io/images/favicon.jpg">

  <!-- schema.org -->
  <meta itemprop="name" content="Wolf Cave">
  <meta itemprop="image" content="">
  <meta itemprop="description" content="">

  <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,600,700' rel='stylesheet' type='text/css'>
  <!-- Style Meta Data -->
  <link rel="stylesheet" href="../theme/css/style.css" type="text/css" />
  <link rel="stylesheet" href="../theme/css/pygments.css" type="text/css" />

  <!-- Feed Meta Data -->

  <!-- Twitter Feed -->
  <meta name="twitter:card" content="summary">
  <meta name="twitter:site" content="">
  <meta name="twitter:image" content="">
</head>

<body>
  <!-- Sidebar -->
  <aside>
    <!--<center><a href=".."><img id="avatar" src=""></a></center>-->
    <h1>Wolf Cave</h1>
      <p>Nature Beauty Freedom</p>
    <br>


    <nav class="nav">
      <ul class="list-bare">
      
          <li><a class="nav__link" href="https://wolfsonliu.github.io/index.html">文章</a></li>
          <li><a class="nav__link" href="https://wolfsonliu.github.io/category/">类别</a></li>
          <li><a class="nav__link" href="https://wolfsonliu.github.io/tag/">标签</a></li>
          <li><a class="nav__link" href="https://wolfsonliu.github.io/about.html">关于</a></li>
         
        
      </ul>
    </nav>

    <p class="social">
        <a href="https://github.com/wolfsonliu" target="_blank" ><img src="../theme/images/icons/github.png"></a>
        <a href="https://www.douban.com/people/77536581/" target="_blank" ><img src="../theme/images/icons/douban.png"></a>
        <a href="https://ebird.org/ebird/profile/NDY3ODYz" target="_blank" ><img src="../theme/images/icons/ebird.png"></a>
        <a href="https://zh.wikipedia.org/wiki/User:Wolfsonliu" target="_blank" ><img src="../theme/images/icons/wikipedia.png"></a>
    </p>



  </aside>

  <!-- Content -->
  <article>
<section id="content" class="body">
        
        <p>functools 中提供了很多方便的工具. 如 reduce 函数的功能类似于在 R 中常用的 Reduce 函数, 可以把接受两个元素的函数累积运算到所有元素.</p>
<h3>函数</h3>
<h4>reduce</h4>
<p><code>reduce</code> 函数类似于 R 中的 Reduce 函数, 是把一个双目函数累积地运用到整个序列的元素上.</p>
<div class="highlight"><pre><span></span><span class="n">reduce</span><span class="p">(</span><span class="n">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">])</span>
<span class="o">#</span> <span class="mi">15</span>
</pre></div>


<h4>partial</h4>
<p><code>partial</code> 函数 (实际上是类) 是用来给一些函数预设一定的参数, 在接下来的调用中就不需要重复传入参数了. <code>partial</code> 的 func 属性是其接受的原来的函数, keywords 属性里则是保存了原来函数的参数的名和值的 dict.</p>
<div class="highlight"><pre><span></span><span class="nb">int</span><span class="p">(</span><span class="s1">&#39;1001&#39;</span><span class="p">,</span> <span class="n">base</span> <span class="o">=</span> <span class="mi">2</span><span class="p">)</span>
<span class="o">#</span> <span class="mi">9</span>
<span class="n">two2ten</span> <span class="o">=</span> <span class="k">partial</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">base</span> <span class="o">=</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">two2ten</span><span class="p">(</span><span class="s1">&#39;1001&#39;</span><span class="p">)</span>
<span class="o">#</span> <span class="mi">9</span>
</pre></div>


<p><code>partialmethod</code> 类似于 <code>partial</code> 函数, 不过是用来对类的 method 进行预先设置.</p>
<div class="highlight"><pre><span></span><span class="nv">class</span> <span class="nv">Call</span>:
    <span class="nv">def</span> <span class="nv">__init__</span><span class="ss">(</span><span class="nv">self</span><span class="ss">)</span>:
        <span class="nv">pass</span>
    <span class="nv">def</span> <span class="nv">callout</span><span class="ss">(</span><span class="nv">self</span>, <span class="nv">sound</span><span class="ss">)</span>:
        <span class="k">return</span> <span class="nv">sound</span>
    <span class="nv">dog</span> <span class="o">=</span> <span class="nv">partialmethod</span><span class="ss">(</span><span class="nv">callout</span>, <span class="nv">sound</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s">Woof!</span><span class="s1">&#39;</span><span class="ss">)</span>
    <span class="nv">cat</span> <span class="o">=</span> <span class="nv">partialmethod</span><span class="ss">(</span><span class="nv">callout</span>, <span class="nv">sound</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s">Mew!</span><span class="s1">&#39;</span><span class="ss">)</span>
<span class="nv">animall</span> <span class="o">=</span> <span class="nv">Call</span><span class="ss">()</span>
<span class="nv">animall</span>.<span class="nv">dog</span><span class="ss">()</span>
# <span class="s1">&#39;</span><span class="s">Woof!</span><span class="s1">&#39;</span>
<span class="nv">animall</span>.<span class="nv">cat</span><span class="ss">()</span>
# <span class="s1">&#39;</span><span class="s">Mew!</span><span class="s1">&#39;</span>
</pre></div>


<h3>修饰器</h3>
<h4>lru_cache</h4>
<p><code>lru_cache</code> 是一个函数修饰器, 用来储存一些频繁调用相同参数的函数的结果, 当再次使用函数的时候可以直接返回结果而不用计算, 提高了速度, 是用空间换时间的策略.</p>
<div class="highlight"><pre><span></span><span class="nv">def</span> <span class="nv">fib</span><span class="ss">(</span><span class="nv">n</span><span class="ss">)</span>:
    <span class="k">if</span> <span class="nv">n</span> <span class="o">&lt;</span> <span class="mi">2</span>:
        <span class="k">return</span> <span class="nv">n</span>
    <span class="k">return</span> <span class="nv">fib</span><span class="ss">(</span><span class="nv">n</span><span class="o">-</span><span class="mi">1</span><span class="ss">)</span> <span class="o">+</span> <span class="nv">fib</span><span class="ss">(</span><span class="nv">n</span><span class="o">-</span><span class="mi">2</span><span class="ss">)</span>

@<span class="nv">lrc_cache</span><span class="ss">(</span><span class="mi">100</span><span class="ss">)</span>
<span class="nv">def</span> <span class="nv">fib2</span><span class="ss">(</span><span class="nv">n</span><span class="ss">)</span>:
    <span class="k">if</span> <span class="nv">n</span> <span class="o">&lt;</span> <span class="mi">2</span>:
        <span class="k">return</span> <span class="nv">n</span>
    <span class="k">return</span> <span class="nv">fib2</span><span class="ss">(</span><span class="nv">n</span><span class="o">-</span><span class="mi">1</span><span class="ss">)</span> <span class="o">+</span> <span class="nv">fib2</span><span class="ss">(</span><span class="nv">n</span><span class="o">-</span><span class="mi">2</span><span class="ss">)</span>
# <span class="o">%</span><span class="nv">timeit</span> [<span class="nv">fib</span><span class="ss">(</span><span class="nv">x</span><span class="ss">)</span> <span class="k">for</span> <span class="nv">x</span> <span class="nv">in</span> <span class="nv">range</span><span class="ss">(</span><span class="mi">10</span><span class="ss">)</span>]
# <span class="mi">10000</span> <span class="nv">loops</span>, <span class="nv">best</span> <span class="nv">of</span> <span class="mi">3</span>: <span class="mi">53</span>.<span class="mi">7</span> µ<span class="nv">s</span> <span class="nv">per</span> <span class="k">loop</span>
# <span class="o">%</span><span class="nv">timeit</span> [<span class="nv">fib2</span><span class="ss">(</span><span class="nv">x</span><span class="ss">)</span> <span class="k">for</span> <span class="nv">x</span> <span class="nv">in</span> <span class="nv">range</span><span class="ss">(</span><span class="mi">10</span><span class="ss">)</span>]
# <span class="nv">The</span> <span class="nv">slowest</span> <span class="nv">run</span> <span class="nv">took</span> <span class="mi">5</span>.<span class="mi">22</span> <span class="nv">times</span> <span class="nv">longer</span> <span class="nv">than</span> <span class="nv">the</span> <span class="nv">fastest</span>.
# <span class="nv">This</span> <span class="nv">could</span> <span class="nv">mean</span> <span class="nv">that</span> <span class="nv">an</span> <span class="nv">intermediate</span> <span class="nb">result</span> <span class="nv">is</span> <span class="nv">being</span> <span class="nv">cached</span>.
# <span class="mi">100000</span> <span class="nv">loops</span>, <span class="nv">best</span> <span class="nv">of</span> <span class="mi">3</span>: <span class="mi">2</span>.<span class="mi">97</span> µ<span class="nv">s</span> <span class="nv">per</span> <span class="k">loop</span>
</pre></div>


<p>可以看到当频繁地使用相同的参数调用函数的时候, lrc_cache 修饰的函数有很高的运行效率.</p>
<h4>total_ordering</h4>
<p><code>total_ordering</code> 是一个类修饰器, 当一个类只定义了 <code>__eq__()</code> 和 <code>__lt()__</code>, <code>__le__()</code>, <code>__gt__()</code>, <code>__ge__()</code> 中的一种时, total_ordering 可以帮助补全其他的方法.</p>
<h4>wraps</h4>
<p><code>wraps</code> 是用来帮助在使用自己编写的函数修饰器的时候能够保留原函数的信息. 官方文档提供了例子.</p>
<div class="highlight"><pre><span></span><span class="nv">def</span> <span class="nv">my_decorator</span><span class="ss">(</span><span class="nv">f</span><span class="ss">)</span>:
    @<span class="nv">wraps</span><span class="ss">(</span><span class="nv">f</span><span class="ss">)</span>
    <span class="nv">def</span> <span class="nv">wrapper</span><span class="ss">(</span><span class="o">*</span><span class="nv">args</span>, <span class="o">**</span><span class="nv">kwds</span><span class="ss">)</span>:
        <span class="nv">print</span><span class="ss">(</span><span class="s1">&#39;</span><span class="s">Calling decorated function</span><span class="s1">&#39;</span><span class="ss">)</span>
        <span class="k">return</span> <span class="nv">f</span><span class="ss">(</span><span class="o">*</span><span class="nv">args</span>, <span class="o">**</span><span class="nv">kwds</span><span class="ss">)</span>
    <span class="k">return</span> <span class="nv">wrapper</span>

<span class="nv">def</span> <span class="nv">my_decorator2</span><span class="ss">(</span><span class="nv">f</span><span class="ss">)</span>:
    <span class="nv">def</span> <span class="nv">wrapper2</span><span class="ss">(</span><span class="o">*</span><span class="nv">args</span>, <span class="o">**</span><span class="nv">kwds</span><span class="ss">)</span>:
        <span class="nv">print</span><span class="ss">(</span><span class="s1">&#39;</span><span class="s">Calling decorated function2</span><span class="s1">&#39;</span><span class="ss">)</span>
        <span class="k">return</span> <span class="nv">f</span><span class="ss">(</span><span class="o">*</span><span class="nv">args</span>, <span class="o">**</span><span class="nv">kwds</span><span class="ss">)</span>
    <span class="k">return</span> <span class="nv">wrapper</span>

@<span class="nv">my_decorator</span>
<span class="nv">def</span> <span class="nv">example</span><span class="ss">()</span>:
    <span class="s2">&quot;&quot;&quot;</span><span class="s">Docstring</span><span class="s2">&quot;&quot;&quot;</span>
    <span class="nv">print</span><span class="ss">(</span><span class="s1">&#39;</span><span class="s">Called example function</span><span class="s1">&#39;</span><span class="ss">)</span>

<span class="nv">example</span><span class="ss">()</span>
# <span class="nv">Calling</span> <span class="nv">decorated</span> <span class="nv">function</span>
# <span class="nv">Called</span> <span class="nv">example</span> <span class="nv">function</span>

<span class="nv">example</span>.<span class="nv">__name__</span>
# <span class="s1">&#39;</span><span class="s">example</span><span class="s1">&#39;</span>
<span class="nv">example</span>.<span class="nv">__doc__</span>
# <span class="s1">&#39;</span><span class="s">Docstring</span><span class="s1">&#39;</span>

@<span class="nv">my_decorator2</span>
<span class="nv">def</span> <span class="nv">example2</span><span class="ss">()</span>:
    <span class="s2">&quot;&quot;&quot;</span><span class="s">Docstring2</span><span class="s2">&quot;&quot;&quot;</span>
    <span class="nv">print</span><span class="ss">(</span><span class="s1">&#39;</span><span class="s">Called example2 function</span><span class="s1">&#39;</span><span class="ss">)</span>

<span class="nv">example2</span><span class="ss">()</span>
# <span class="nv">Calling</span> <span class="nv">decorated</span> <span class="nv">function2</span>
# <span class="nv">Called</span> <span class="nv">example2</span> <span class="nv">function</span>
<span class="nv">example2</span>.<span class="nv">__name__</span>
# <span class="s1">&#39;</span><span class="s">wrapper2</span><span class="s1">&#39;</span>
<span class="nv">example2</span>.<span class="nv">__doc__</span>
#
</pre></div>


<p>可以看到在不在自己定义的修饰器中使用 wraps, 其修饰的函数的属性实际上是返回的修饰函数的属性. 而 wraps 可以让被修饰的函数的依然保留之前的属性.</p>
</section>
  </article>

  <!-- Footer -->
  <footer>
    <p>
      Blog powered by <a href="http://getpelican.com/">Pelican</a>, 
      which takes great advantage of <a href="http://python.org">Python</a>.
      Theme <a href="https://github.com/parbhat/pelican-blue">Pelican-Blue</a> by <a href="https://parbhatpuri.com/">@parbhat</a>.
    </p>
  </footer>


</body>
</html>